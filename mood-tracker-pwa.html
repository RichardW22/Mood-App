<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Track moods, triggers, and outcomes">
    <title>Mood Tracker</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect } from 'https://cdn.skypack.dev/react';
        import ReactDOM from 'https://cdn.skypack.dev/react-dom';

        const MoodTracker = () => {
            const [entries, setEntries] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [showPatterns, setShowPatterns] = useState(false);
            const [formData, setFormData] = useState({
                mood: '',
                trigger: '',
                result: '',
                notes: ''
            });

            const moods = ['Very Happy', 'Happy', 'Neutral', 'Sad', 'Very Sad', 'Anxious', 'Angry', 'Calm'];
            const moodColors = {
                'Very Happy': 'bg-green-500',
                'Happy': 'bg-green-400',
                'Neutral': 'bg-gray-400',
                'Sad': 'bg-blue-400',
                'Very Sad': 'bg-blue-600',
                'Anxious': 'bg-yellow-500',
                'Angry': 'bg-red-500',
                'Calm': 'bg-purple-400'
            };

            useEffect(() => {
                loadData();
                registerServiceWorker();
            }, []);

            const registerServiceWorker = async () => {
                if ('serviceWorker' in navigator) {
                    try {
                        await navigator.serviceWorker.register('/sw.js');
                    } catch (error) {
                        console.log('Service Worker registration failed');
                    }
                }
            };

            const loadData = () => {
                try {
                    const saved = localStorage.getItem('mood-entries');
                    if (saved) {
                        setEntries(JSON.parse(saved));
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            };

            const saveData = (newEntries) => {
                try {
                    localStorage.setItem('mood-entries', JSON.stringify(newEntries));
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            };

            const handleSubmit = () => {
                if (!formData.mood || !formData.trigger || !formData.result) return;
                
                const newEntry = {
                    ...formData,
                    id: Date.now(),
                    timestamp: new Date().toISOString()
                };
                const updatedEntries = [newEntry, ...entries];
                setEntries(updatedEntries);
                saveData(updatedEntries);
                setFormData({ mood: '', trigger: '', result: '', notes: '' });
                setShowForm(false);
            };

            const deleteEntry = (id) => {
                const updatedEntries = entries.filter(e => e.id !== id);
                setEntries(updatedEntries);
                saveData(updatedEntries);
            };

            const formatDate = (timestamp) => {
                const date = new Date(timestamp);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            };

            const getMoodCount = () => {
                const counts = {};
                entries.forEach(entry => {
                    counts[entry.mood] = (counts[entry.mood] || 0) + 1;
                });
                return counts;
            };

            const analyzePatterns = () => {
                const triggerMap = {};
                const resultMap = {};
                
                entries.forEach(entry => {
                    const trigger = entry.trigger.toLowerCase();
                    const result = entry.result.toLowerCase();
                    
                    if (!triggerMap[trigger]) {
                        triggerMap[trigger] = { count: 0, moods: {} };
                    }
                    triggerMap[trigger].count++;
                    triggerMap[trigger].moods[entry.mood] = (triggerMap[trigger].moods[entry.mood] || 0) + 1;
                    
                    if (!resultMap[result]) {
                        resultMap[result] = { count: 0, moods: {} };
                    }
                    resultMap[result].count++;
                    resultMap[result].moods[entry.mood] = (resultMap[result].moods[entry.mood] || 0) + 1;
                });

                const sortedTriggers = Object.entries(triggerMap)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 5);
                
                const sortedResults = Object.entries(resultMap)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 5);

                return { triggers: sortedTriggers, results: sortedResults };
            };

            const exportData = () => {
                const patterns = analyzePatterns();
                const moodCounts = getMoodCount();
                
                const reportData = {
                    summary: {
                        totalEntries: entries.length,
                        dateRange: entries.length > 0 ? {
                            earliest: formatDate(entries[entries.length - 1].timestamp),
                            latest: formatDate(entries[0].timestamp)
                        } : null,
                        moodDistribution: moodCounts
                    },
                    patterns: {
                        topTriggers: patterns.triggers.map(([trigger, data]) => ({
                            trigger,
                            occurrences: data.count,
                            associatedMoods: data.moods
                        })),
                        topResults: patterns.results.map(([result, data]) => ({
                            result,
                            occurrences: data.count,
                            associatedMoods: data.moods
                        }))
                    },
                    allEntries: entries.map(e => ({
                        date: formatDate(e.timestamp),
                        mood: e.mood,
                        trigger: e.trigger,
                        result: e.result,
                        notes: e.notes
                    }))
                };

                const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mood-tracker-report-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const moodCounts = getMoodCount();
            const patterns = entries.length > 0 ? analyzePatterns() : null;

            return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4' },
                React.createElement('div', { className: 'max-w-4xl mx-auto' },
                    React.createElement('div', { className: 'bg-white rounded-lg shadow-lg p-6 mb-6' },
                        React.createElement('div', { className: 'flex items-center justify-between mb-6' },
                            React.createElement('h1', { className: 'text-3xl font-bold text-gray-800' }, 'Mood Tracker'),
                            React.createElement('div', { className: 'flex gap-2' },
                                React.createElement('button', {
                                    onClick: () => setShowPatterns(!showPatterns),
                                    className: 'bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm'
                                }, 'Patterns'),
                                React.createElement('button', {
                                    onClick: exportData,
                                    className: 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm'
                                }, 'Export'),
                                React.createElement('button', {
                                    onClick: () => setShowForm(!showForm),
                                    className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm'
                                }, '+ New')
                            )
                        ),

                        showForm && React.createElement('div', { className: 'bg-gray-50 p-6 rounded-lg mb-6' },
                            React.createElement('div', { className: 'space-y-4' },
                                React.createElement('div', null,
                                    React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Mood *'),
                                    React.createElement('select', {
                                        value: formData.mood,
                                        onChange: (e) => setFormData({ ...formData, mood: e.target.value }),
                                        className: 'w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                    },
                                        React.createElement('option', { value: '' }, 'Select a mood'),
                                        moods.map(mood => React.createElement('option', { key: mood, value: mood }, mood))
                                    )
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Trigger *'),
                                    React.createElement('input', {
                                        type: 'text',
                                        value: formData.trigger,
                                        onChange: (e) => setFormData({ ...formData, trigger: e.target.value }),
                                        placeholder: 'What caused this mood?',
                                        className: 'w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                    })
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Result/Outcome *'),
                                    React.createElement('input', {
                                        type: 'text',
                                        value: formData.result,
                                        onChange: (e) => setFormData({ ...formData, result: e.target.value }),
                                        placeholder: 'What happened as a result?',
                                        className: 'w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                    })
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Additional Notes'),
                                    React.createElement('textarea', {
                                        value: formData.notes,
                                        onChange: (e) => setFormData({ ...formData, notes: e.target.value }),
                                        placeholder: 'Any additional context...',
                                        rows: 3,
                                        className: 'w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                    })
                                ),
                                React.createElement('div', { className: 'flex gap-3' },
                                    React.createElement('button', {
                                        onClick: handleSubmit,
                                        className: 'bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition'
                                    }, 'Save Entry'),
                                    React.createElement('button', {
                                        onClick: () => setShowForm(false),
                                        className: 'bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition'
                                    }, 'Cancel')
                                )
                            )
                        ),

                        showPatterns && patterns && entries.length > 0 && React.createElement('div', { className: 'bg-purple-50 p-6 rounded-lg mb-6' },
                            React.createElement('h2', { className: 'text-xl font-bold text-gray-800 mb-4' }, 'Pattern Analysis'),
                            React.createElement('div', { className: 'grid md:grid-cols-2 gap-6' },
                                React.createElement('div', null,
                                    React.createElement('h3', { className: 'font-semibold text-gray-700 mb-3' }, 'Top Triggers'),
                                    patterns.triggers.map(([trigger, data], idx) =>
                                        React.createElement('div', { key: idx, className: 'bg-white p-3 rounded mb-2' },
                                            React.createElement('div', { className: 'font-medium text-gray-800 capitalize' }, trigger),
                                            React.createElement('div', { className: 'text-sm text-gray-600' }, `Occurred ${data.count} times`),
                                            React.createElement('div', { className: 'text-xs text-gray-500 mt-1' },
                                                `Moods: ${Object.entries(data.moods).map(([m, c]) => `${m} (${c})`).join(', ')}`
                                            )
                                        )
                                    )
                                ),
                                React.createElement('div', null,
                                    React.createElement('h3', { className: 'font-semibold text-gray-700 mb-3' }, 'Top Results'),
                                    patterns.results.map(([result, data], idx) =>
                                        React.createElement('div', { key: idx, className: 'bg-white p-3 rounded mb-2' },
                                            React.createElement('div', { className: 'font-medium text-gray-800 capitalize' }, result),
                                            React.createElement('div', { className: 'text-sm text-gray-600' }, `Occurred ${data.count} times`),
                                            React.createElement('div', { className: 'text-xs text-gray-500 mt-1' },
                                                `Moods: ${Object.entries(data.moods).map(([m, c]) => `${m} (${c})`).join(', ')}`
                                            )
                                        )
                                    )
                                )
                            )
                        ),

                        entries.length > 0 && React.createElement('div', { className: 'mb-6 p-4 bg-blue-50 rounded-lg' },
                            React.createElement('h2', { className: 'text-lg font-semibold text-gray-800 mb-3' }, 'Mood Summary'),
                            React.createElement('div', { className: 'flex flex-wrap gap-2' },
                                Object.entries(moodCounts).map(([mood, count]) =>
                                    React.createElement('div', { key: mood, className: 'flex items-center gap-2' },
                                        React.createElement('span', { className: `${moodColors[mood]} w-3 h-3 rounded-full` }),
                                        React.createElement('span', { className: 'text-sm text-gray-700' }, `${mood}: ${count}`)
                                    )
                                )
                            ),
                            React.createElement('p', { className: 'text-sm text-gray-600 mt-2' }, `Total entries: ${entries.length}`)
                        )
                    ),

                    React.createElement('div', { className: 'space-y-4' },
                        entries.length === 0 ? React.createElement('div', { className: 'bg-white rounded-lg shadow p-8 text-center text-gray-500' },
                            React.createElement('p', null, 'No entries yet. Click "+ New" to start tracking.'),
                            React.createElement('p', { className: 'text-sm mt-2' }, 'Data saves automatically on your device.')
                        ) : entries.map(entry =>
                            React.createElement('div', { key: entry.id, className: 'bg-white rounded-lg shadow-md p-6' },
                                React.createElement('div', { className: 'flex items-start justify-between mb-3' },
                                    React.createElement('div', { className: 'flex items-center gap-3' },
                                        React.createElement('span', { className: `${moodColors[entry.mood]} w-4 h-4 rounded-full` }),
                                        React.createElement('h3', { className: 'text-xl font-semibold text-gray-800' }, entry.mood)
                                    ),
                                    React.createElement('div', { className: 'flex items-center gap-2' },
                                        React.createElement('span', { className: 'text-sm text-gray-500' }, formatDate(entry.timestamp)),
                                        React.createElement('button', {
                                            onClick: () => deleteEntry(entry.id),
                                            className: 'text-red-500 hover:text-red-700 p-1 text-sm'
                                        }, 'üóëÔ∏è')
                                    )
                                ),
                                React.createElement('div', { className: 'space-y-3' },
                                    React.createElement('div', null,
                                        React.createElement('p', { className: 'text-sm font-medium text-gray-600' }, 'Trigger:'),
                                        React.createElement('p', { className: 'text-gray-800' }, entry.trigger)
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('p', { className: 'text-sm font-medium text-gray-600' }, 'Result:'),
                                        React.createElement('p', { className: 'text-gray-800' }, entry.result)
                                    ),
                                    entry.notes && React.createElement('div', { className: 'pt-2 border-t border-gray-200' },
                                        React.createElement('p', { className: 'text-sm font-medium text-gray-600 mb-1' }, 'Notes:'),
                                        React.createElement('p', { className: 'text-gray-700 text-sm' }, entry.notes)
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(MoodTracker), document.getElementById('root'));
    </script>
</body>
</html>