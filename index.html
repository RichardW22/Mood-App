<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Track moods, triggers, and outcomes">
    <title>Mood Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6NxI8HwDT2ug68AWMtilyHhsjt8ZuFYrGWTPknYojECfxNizPQgIOBSOTptDOIofJog/exec';

        const MoodTracker = () => {
            const [entries, setEntries] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [showPatterns, setShowPatterns] = useState(false);
            const [userName, setUserName] = useState('');
            const [showNamePrompt, setShowNamePrompt] = useState(true);
            const [formData, setFormData] = useState({
                mood: '',
                trigger: '',
                result: '',
                notes: ''
            });

            const moods = ['Very Happy', 'Happy', 'Neutral', 'Sad', 'Very Sad', 'Anxious', 'Angry', 'Calm'];
            const moodColors = {
                'Very Happy': 'bg-green-500',
                'Happy': 'bg-green-400',
                'Neutral': 'bg-gray-400',
                'Sad': 'bg-blue-400',
                'Very Sad': 'bg-blue-600',
                'Anxious': 'bg-yellow-500',
                'Angry': 'bg-red-500',
                'Calm': 'bg-purple-400'
            };

            useEffect(() => {
                const savedName = localStorage.getItem('mood-tracker-username');
                if (savedName) {
                    setUserName(savedName);
                    setShowNamePrompt(false);
                }
                loadData();
            }, []);

            const handleNameSubmit = () => {
                if (userName.trim()) {
                    localStorage.setItem('mood-tracker-username', userName.trim());
                    setShowNamePrompt(false);
                }
            };

            const loadData = () => {
                try {
                    const saved = localStorage.getItem('mood-entries');
                    if (saved) {
                        setEntries(JSON.parse(saved));
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            };

            const saveData = (newEntries) => {
                try {
                    localStorage.setItem('mood-entries', JSON.stringify(newEntries));
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            };

            const sendToGoogleSheets = async (entry) => {
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: userName,
                            timestamp: entry.timestamp,
                            mood: entry.mood,
                            trigger: entry.trigger,
                            results: entry.result,
                            notes: entry.notes
                        })
                    });
                    console.log('Data sent to Google Sheets');
                } catch (error) {
                    console.error('Error sending to Google Sheets:', error);
                }
            };

            const handleSubmit = () => {
                if (!formData.mood || !formData.trigger || !formData.result) return;
                
                const newEntry = {
                    ...formData,
                    id: Date.now(),
                    timestamp: new Date().toISOString()
                };
                
                // Send to Google Sheets
                sendToGoogleSheets(newEntry);
                
                // Save locally
                const updatedEntries = [newEntry, ...entries];
                setEntries(updatedEntries);
                saveData(updatedEntries);
                setFormData({ mood: '', trigger: '', result: '', notes: '' });
                setShowForm(false);
            };

            const deleteEntry = (id) => {
                const updatedEntries = entries.filter(e => e.id !== id);
                setEntries(updatedEntries);
                saveData(updatedEntries);
            };

            const formatDate = (timestamp) => {
                const date = new Date(timestamp);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            };

            const getMoodCount = () => {
                const counts = {};
                entries.forEach(entry => {
                    counts[entry.mood] = (counts[entry.mood] || 0) + 1;
                });
                return counts;
            };

            const analyzePatterns = () => {
                const triggerMap = {};
                const resultMap = {};
                
                entries.forEach(entry => {
                    const trigger = entry.trigger.toLowerCase();
                    const result = entry.result.toLowerCase();
                    
                    if (!triggerMap[trigger]) {
                        triggerMap[trigger] = { count: 0, moods: {} };
                    }
                    triggerMap[trigger].count++;
                    triggerMap[trigger].moods[entry.mood] = (triggerMap[trigger].moods[entry.mood] || 0) + 1;
                    
                    if (!resultMap[result]) {
                        resultMap[result] = { count: 0, moods: {} };
                    }
                    resultMap[result].count++;
                    resultMap[result].moods[entry.mood] = (resultMap[result].moods[entry.mood] || 0) + 1;
                });

                const sortedTriggers = Object.entries(triggerMap)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 5);
                
                const sortedResults = Object.entries(resultMap)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 5);

                return { triggers: sortedTriggers, results: sortedResults };
            };

            const exportData = () => {
                const patterns = analyzePatterns();
                const moodCounts = getMoodCount();
                
                const reportData = {
                    userName: userName,
                    summary: {
                        totalEntries: entries.length,
                        dateRange: entries.length > 0 ? {
                            earliest: formatDate(entries[entries.length - 1].timestamp),
                            latest: formatDate(entries[0].timestamp)
                        } : null,
                        moodDistribution: moodCounts
                    },
                    patterns: {
                        topTriggers: patterns.triggers.map(([trigger, data]) => ({
                            trigger,
                            occurrences: data.count,
                            associatedMoods: data.moods
                        })),
                        topResults: patterns.results.map(([result, data]) => ({
                            result,
                            occurrences: data.count,
                            associatedMoods: data.moods
                        }))
                    },
                    allEntries: entries.map(e => ({
                        date: formatDate(e.timestamp),
                        mood: e.mood,
                        trigger: e.trigger,
                        result: e.result,
                        notes: e.notes
                    }))
                };

                const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mood-tracker-${userName}-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const moodCounts = getMoodCount();
            const patterns = entries.length > 0 ? analyzePatterns() : null;

            if (showNamePrompt) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4 flex items-center justify-center">
                        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
                            <h1 className="text-3xl font-bold text-gray-800 mb-4">Welcome to Mood Tracker</h1>
                            <p className="text-gray-600 mb-6">
                                Your entries will be saved to help track patterns. Please enter an identifier (name, code, or username).
                            </p>
                            <p className="text-sm text-gray-500 mb-4">
                                ‚ö†Ô∏è Your data will be shared with the researcher. Choose how you identify yourself.
                            </p>
                            <input
                                type="text"
                                value={userName}
                                onChange={(e) => setUserName(e.target.value)}
                                placeholder="Enter your name or identifier"
                                className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                onKeyPress={(e) => e.key === 'Enter' && handleNameSubmit()}
                            />
                            <button
                                onClick={handleNameSubmit}
                                disabled={!userName.trim()}
                                className="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
                            >
                                Continue
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-800">Mood Tracker</h1>
                                    <p className="text-sm text-gray-600">Tracking as: {userName}</p>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setShowPatterns(!showPatterns)}
                                        className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm"
                                    >
                                        Patterns
                                    </button>
                                    <button
                                        onClick={exportData}
                                        className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm"
                                    >
                                        Export
                                    </button>
                                    <button
                                        onClick={() => setShowForm(!showForm)}
                                        className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm"
                                    >
                                        + New
                                    </button>
                                </div>
                            </div>

                            {showForm && (
                                <div className="bg-gray-50 p-6 rounded-lg mb-6">
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Mood *
                                            </label>
                                            <select
                                                value={formData.mood}
                                                onChange={(e) => setFormData({ ...formData, mood: e.target.value })}
                                                className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            >
                                                <option value="">Select a mood</option>
                                                {moods.map(mood => (
                                                    <option key={mood} value={mood}>{mood}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Trigger *
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.trigger}
                                                onChange={(e) => setFormData({ ...formData, trigger: e.target.value })}
                                                placeholder="What caused this mood?"
                                                className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Result/Outcome *
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.result}
                                                onChange={(e) => setFormData({ ...formData, result: e.target.value })}
                                                placeholder="What happened as a result?"
                                                className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Additional Notes
                                            </label>
                                            <textarea
                                                value={formData.notes}
                                                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                                placeholder="Any additional context..."
                                                rows="3"
                                                className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            />
                                        </div>

                                        <div className="flex gap-3">
                                            <button
                                                onClick={handleSubmit}
                                                className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"
                                            >
                                                Save Entry
                                            </button>
                                            <button
                                                onClick={() => setShowForm(false)}
                                                className="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {showPatterns && patterns && entries.length > 0 && (
                                <div className="bg-purple-50 p-6 rounded-lg mb-6">
                                    <h2 className="text-xl font-bold text-gray-800 mb-4">Pattern Analysis</h2>
                                    <div className="grid md:grid-cols-2 gap-6">
                                        <div>
                                            <h3 className="font-semibold text-gray-700 mb-3">Top Triggers</h3>
                                            {patterns.triggers.map(([trigger, data], idx) => (
                                                <div key={idx} className="bg-white p-3 rounded mb-2">
                                                    <div className="font-medium text-gray-800 capitalize">{trigger}</div>
                                                    <div className="text-sm text-gray-600">Occurred {data.count} times</div>
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        Moods: {Object.entries(data.moods).map(([m, c]) => `${m} (${c})`).join(', ')}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        <div>
                                            <h3 className="font-semibold text-gray-700 mb-3">Top Results</h3>
                                            {patterns.results.map(([result, data], idx) => (
                                                <div key={idx} className="bg-white p-3 rounded mb-2">
                                                    <div className="font-medium text-gray-800 capitalize">{result}</div>
                                                    <div className="text-sm text-gray-600">Occurred {data.count} times</div>
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        Moods: {Object.entries(data.moods).map(([m, c]) => `${m} (${c})`).join(', ')}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {entries.length > 0 && (
                                <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                    <h2 className="text-lg font-semibold text-gray-800 mb-3">Mood Summary</h2>
                                    <div className="flex flex-wrap gap-2">
                                        {Object.entries(moodCounts).map(([mood, count]) => (
                                            <div key={mood} className="flex items-center gap-2">
                                                <span className={`${moodColors[mood]} w-3 h-3 rounded-full`}></span>
                                                <span className="text-sm text-gray-700">{mood}: {count}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <p className="text-sm text-gray-600 mt-2">Total entries: {entries.length}</p>
                                </div>
                            )}
                        </div>

                        <div className="space-y-4">
                            {entries.length === 0 ? (
                                <div className="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                                    <p>No entries yet. Click "+ New" to start tracking.</p>
                                    <p className="text-sm mt-2">Data saves locally and sends to Google Sheets.</p>
                                </div>
                            ) : (
                                entries.map(entry => (
                                    <div key={entry.id} className="bg-white rounded-lg shadow-md p-6">
                                        <div className="flex items-start justify-between mb-3">
                                            <div className="flex items-center gap-3">
                                                <span className={`${moodColors[entry.mood]} w-4 h-4 rounded-full`}></span>
                                                <h3 className="text-xl font-semibold text-gray-800">{entry.mood}</h3>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm text-gray-500">{formatDate(entry.timestamp)}</span>
                                                <button
                                                    onClick={() => deleteEntry(entry.id)}
                                                    className="text-red-500 hover:text-red-700 p-1 text-sm"
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            <div>
                                                <p className="text-sm font-medium text-gray-600">Trigger:</p>
                                                <p className="text-gray-800">{entry.trigger}</p>
                                            </div>
                                            
                                            <div>
                                                <p className="text-sm font-medium text-gray-600">Result:</p>
                                                <p className="text-gray-800">{entry.result}</p>
                                            </div>
                                            
                                            {entry.notes && (
                                                <div className="pt-2 border-t border-gray-200">
                                                    <p className="text-sm font-medium text-gray-600 mb-1">Notes:</p>
                                                    <p className="text-gray-700 text-sm">{entry.notes}</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<MoodTracker />, document.getElementById('root'));
    </script>
</body>
</html>
